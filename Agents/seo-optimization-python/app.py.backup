from flask import Flask, request, jsonify
import os
import json
import uuid
from datetime import datetime
import logging
import re

# Configure logging
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = Flask(__name__)

# Storage paths
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
DATA_DIR = os.path.join(BASE_DIR, 'data')
REPORTS_DIR = os.path.join(DATA_DIR, 'reports')

# Create directories if they don't exist
os.makedirs(DATA_DIR, exist_ok=True)
os.makedirs(REPORTS_DIR, exist_ok=True)

@app.route('/health', methods=['GET'])
def health_check():
    """Health check endpoint"""
    return jsonify({"status": "healthy", "service": "SEO Optimization Python Agent"}), 200

@app.route('/optimize-content', methods=['POST'])
def optimize_content():
    """Optimize content for search engines"""
    try:
        data = request.get_json()
        content = data.get('content', '')
        keywords = data.get('keywords', [])
        url = data.get('url', '')

        if not content:
            return jsonify({"error": "Content is required"}), 400

        logger.info(f"Optimizing content for SEO: {url}")

        # Perform SEO optimization
        optimized_content = perform_seo_optimization(content, keywords)

        # Generate optimization ID
        optimization_id = str(uuid.uuid4())

        # Save optimization result
        optimization_result = {
            'id': optimization_id,
            'url': url,
            'originalContent': content,
            'optimizedContent': optimized_content,
            'keywords': keywords,
            'seoScore': calculate_seo_score(optimized_content, keywords),
            'improvements': identify_improvements(content, optimized_content),
            'createdAt': datetime.now().isoformat()
        }

        logger.info(f"Content SEO optimization completed: {optimization_id}")
        return jsonify({
            "message": "Content SEO optimization successful",
            "optimizationId": optimization_id,
            "result": optimization_result
        }), 200
    except Exception as e:
        logger.error(f"Error in content SEO optimization: {str(e)}")
        return jsonify({"error": str(e)}), 500

@app.route('/analyze-metrics', methods=['POST'])
def analyze_metrics():
    """Analyze SEO metrics for content"""
    try:
        data = request.get_json()
        url = data.get('url', '')
        content = data.get('content', '')

        if not url and not content:
            return jsonify({"error": "URL or content is required"}), 400

        logger.info(f"Analyzing SEO metrics: {url}")

        # Perform SEO metrics analysis
        metrics = perform_seo_metrics_analysis(url, content)

        # Generate analysis ID
        analysis_id = str(uuid.uuid4())

        # Save analysis result
        analysis_result = {
            'id': analysis_id,
            'url': url,
            'metrics': metrics,
            'createdAt': datetime.now().isoformat()
        }

        logger.info(f"SEO metrics analysis completed: {analysis_id}")
        return jsonify({
            "message": "SEO metrics analysis successful",
            "analysisId": analysis_id,
            "result": analysis_result
        }), 200
    except Exception as e:
        logger.error(f"Error in SEO metrics analysis: {str(e)}")
        return jsonify({"error": str(e)}), 500

@app.route('/generate-report', methods=['POST'])
def generate_report():
    """Generate comprehensive SEO report"""
    try:
        data = request.get_json()
        urls = data.get('urls', [])
        contents = data.get('contents', [])

        if not urls and not contents:
            return jsonify({"error": "URLs or contents are required"}), 400

        logger.info("Generating SEO report")

        # Generate SEO report
        report_data = generate_seo_report(urls, contents)

        # Generate report ID
        report_id = str(uuid.uuid4())

        # Save report
        report = {
            'id': report_id,
            'data': report_data,
            'createdAt': datetime.now().isoformat()
        }
        save_report(report)

        logger.info(f"SEO report generation completed: {report_id}")
        return jsonify({
            "message": "SEO report generation successful",
            "reportId": report_id,
            "report": report_data
        }), 200
    except Exception as e:
        logger.error(f"Error in SEO report generation: {str(e)}")
        return jsonify({"error": str(e)}), 500

@app.route('/get-report/<report_id>', methods=['GET'])
def get_report(report_id):
    """Get SEO report by ID"""
    try:
        report = load_report(report_id)
        if not report:
            return jsonify({"error": "Report not found"}), 404

        logger.info(f"SEO report retrieved: {report_id}")
        return jsonify({
            "message": "SEO report retrieved successfully",
            "report": report
        }), 200
    except Exception as e:
        logger.error(f"Error retrieving SEO report: {str(e)}")
        return jsonify({"error": str(e)}), 500

def perform_seo_optimization(content, keywords):
    """Perform SEO optimization on content"""
    # This is a simplified optimization
    # In a real implementation, this would use more sophisticated techniques

    optimized_content = content

    # Add keywords naturally if missing
    for keyword in keywords:
        if keyword.lower() not in content.lower():
            # Add keyword to the beginning of the content
            optimized_content = f"Important: {keyword}. {optimized_content}"

    # Improve readability by adding paragraph breaks
    if len(content) > 1000:
        sentences = re.split(r'([.!?]+)', content)
        optimized_content = ''.join(
            sentence + ('\n\n' if i % 5 == 4 else '')
            for i, sentence in enumerate(sentences)
        )

    return optimized_content

def calculate_seo_score(content, keywords):
    """Calculate SEO score for content"""
    score = 50  # Base score

    # Word count factor
    word_count = len(content.split())
    if 300 <= word_count <= 2000:
        score += 20
    elif word_count > 2000:
        score += 10

    # Keyword factor
    keyword_count = sum(1 for keyword in keywords if keyword.lower() in content.lower())
    score += min(keyword_count * 10, 30)

    return min(score, 100)

def identify_improvements(original_content, optimized_content):
    """Identify improvements made to content"""
    improvements = []

    if len(optimized_content) > len(original_content):
        improvements.append("Added relevant keywords")

    if '\n\n' in optimized_content and '\n\n' not in original_content:
        improvements.append("Improved content structure")

    if not improvements:
        improvements.append("Content optimized for better readability")

    return improvements

def perform_seo_metrics_analysis(url, content):
    """Perform SEO metrics analysis"""
    # This is a simplified analysis
    # In a real implementation, this would use actual SEO tools

    metrics = {
        'pageSpeed': 85,
        'mobileFriendly': True,
        'sslSecured': url.startswith('https') if url else True,
        'wordCount': len(content.split()) if content else 0,
        'headingStructure': {
            'h1Count': len(re.findall(r'<h1[^>]*>.*?</h1>', content, re.IGNORECASE | re.DOTALL)) if content else 0,
            'h2Count': len(re.findall(r'<h2[^>]*>.*?</h2>', content, re.IGNORECASE | re.DOTALL)) if content else 0
        },
        'internalLinks': len(re.findall(r'<a[^>]*href=("|\')(/.*?)("|\')[^>]*>', content)) if content else 0,
        'externalLinks': len(re.findall(r'<a[^>]*href=("|\')(https?://.*?)("|\')[^>]*>', content)) if content else 0
    }

    return metrics

def generate_seo_report(urls, contents):
    """Generate comprehensive SEO report"""
    # This is a simplified report generation
    # In a real implementation, this would analyze multiple factors

    report = {
        'generatedAt': datetime.now().isoformat(),
        'urlsAnalyzed': len(urls),
        'contentsAnalyzed': len(contents),
        'overallScore': 85,
        'averagePageSpeed': 82,
        'mobileFriendlyPercentage': 95,
        'topRecommendations': [
            'Improve page load speed',
            'Add more internal links',
            'Optimize images for web',
            'Improve heading structure'
        ],
        'commonIssues': [
            'Missing meta descriptions',
            'Insufficient keyword density',
            'Poor content structure'
        ]
    }

    return report

def save_report(report):
    """Save SEO report to file"""
    try:
        file_path = os.path.join(REPORTS_DIR, f"{report['id']}_report.json")
        with open(file_path, 'w') as f:
            json.dump(report, f, indent=2)
    except Exception as e:
        logger.error(f"Error saving SEO report: {str(e)}")
        raise

def load_report(report_id):
    """Load SEO report from file"""
    try:
        file_path = os.path.join(REPORTS_DIR, f"{report_id}_report.json")
        if not os.path.exists(file_path):
            return None
        with open(file_path, 'r') as f:
            return json.load(f)
    except Exception as e:
        logger.error(f"Error loading SEO report: {str(e)}")
        return None

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)